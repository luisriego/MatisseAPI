{% extends 'admin/layout.html.twig' %}

{% block title %}{{ 'admin.slip_generation_title'|trans }}{% endblock %}

{% block page_title %}{{ 'admin.slip_generation_title'|trans }}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ path('admin_index') }}">{{ 'menu.admin'|trans }}</a></li>
    <li class="breadcrumb-item"><a href="{{ path('admin_slip_generation') }}">{{ 'menu.slip'|trans }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ 'admin.slip_generation_title'|trans }}</li>
{% endblock %}

{% block main %}
    <div class="container-fluid mt-0">

        {{ form_start(form) }}
        <div class="row">
            <div class="col-lg-12">
                <div class="card mb-8">
                    <div class="card-header">
                        <h5 class="card-title mb-0">1. Selecione o Mês de Referência</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-0">
                            {{ form_widget(form.targetMonth, {'attr': {'onchange': 'this.form.submit()'}}) }}
                            <small class="form-text text-muted">{{ form_help(form.targetMonth) }}</small>
                            {{ form_errors(form.targetMonth) }}
                        </div>
                    </div>
                </div>

                {# SEÇÃO PARA GASTOS RECORRENTES #}
                {% if form.recurringExpenses is defined and form.recurringExpenses|length > 0 %}
                    <div class="card mb-8">
                        <div class="card-header">
                            <h5 class="card-title mb-0">2. Confirme os Gastos Recorrentes para o Mês</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0 align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width: 70px;" class="text-center">{{ 'Incluir'|trans }}</th>
                                        <th>{{ 'Descrição do Gasto Recorrente'|trans }}</th>
                                        <th>{{ 'Data de Vencimento'|trans }}</th>
                                        <th style="width: 200px;">{{ 'Valor (R$)'|trans }}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for item_form in form.recurringExpenses %}
                                        <tr>
                                            <td class="text-center">
                                                <div class="form-check d-inline-flex justify-content-center align-items-center" style="min-height: 31px;">
                                                    {{ form_widget(item_form.include, {'attr': {'class': 'form-check-input'}}) }}
                                                </div>
                                                {{ form_errors(item_form.include) }}
                                            </td>
                                            <td>
                                                <label for="{{ item_form.include.vars.id }}" class="form-check-label mb-0" style="cursor: pointer;">
                                                    {{ item_form.vars.data.description | default('Descrição não disponível') }}
                                                </label>
                                                {{ form_widget(item_form.recurringExpenseId) }}
                                                {{ form_widget(item_form.description) }}
                                            </td>
                                            <td>
                                                {{ form_widget(item_form.dueDate) }}
                                                {{ form_errors(item_form.dueDate) }}
                                            </td>
                                            <td>
                                                {{ form_widget(item_form.amount) }}
                                                {{ form_errors(item_form.amount) }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if form.recurringExpenses.vars.errors|length > 0 %}
                                <div class="alert alert-danger mb-0 p-2">
                                    {{ form_errors(form.recurringExpenses) }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% elseif form.targetMonth.vars.data is not null %}
                    <div class="alert alert-info">Todos os gastos recorrentes configurados ou ativos para o mês selecionado, já foram incluídos.</div>
                {% endif %}

                {# Lógica de ADVERTÊNCIA de boletos existentes (sem checkbox de confirmação) #}
                {% if form.vars.needs_confirmation %} {# Apenas checa se a confirmação é necessária (boletos existem) #}
                    <div class="card mb-8 mt-2 mb-2">
                        <div class="card-header">
                            {# Você pode manter este título ou simplificá-lo, já que não há mais uma "confirmação" ativa #}
                            <h5 class="card-title mb-0">Atenção: Boletos Existentes</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <strong>Atenção!</strong> Já existem {{ form.vars.existing_slips_count }} boleto(s) gerados para este mês.
                                Clicar em "Gerar Novos Boletos e Eliminar os Existentes" irá substituí-los.
                            </div>
                            {% set submit_button_label = 'Gerar Boletos Agora' %}
                            {% if form.vars.needs_confirmation %}
                                {% set submit_button_label = 'Gerar Novos Boletos e Eliminar os Existentes' %}
                            {% endif %}
                            {{ form_widget(form.submit, {'label': submit_button_label|trans, 'attr': {'class': 'btn btn-primary btn-lg'}}) }}
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="col-lg-12">
                {% if selectedMonthName is defined and selectedMonthName is not empty %}
                    <div class="card sticky-top" style="top: 70px;">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Despesas Efetivas para {{ selectedMonthName }}</h5>
                        </div>
                        <div class="card-body p-0">
                            {% include 'admin/_partials/_expense_table.html.twig' with {
                                'expenses_list': monthlyExpenses,
                                'show_actions': false,
                                'no_expenses_message_key': 'expense.list.no_expenses_for_month'
                            } %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {{ form_end(form) }}
    </div>
{% endblock %}


{% block sidebar %}
    <div class="section actions">
        <a href="{{ path('admin_expense_list') }}" class="btn btn-lg btn-block btn-success">
            <i class="fa fa-list" aria-hidden="true"></i> {{ 'slip.list_action'|trans }}
        </a>
    </div>

    {{ parent() }}
{% endblock %}
